![Build](https://github.com/clarkzjw/mmsys24-starlink-livestreaming/actions/workflows/build.yaml/badge.svg)

**[WIP]** 

This repository contains the implementation for the paper *Low-Latency Live Video Streaming over a Low-Earth-Orbit Satellite Network with DASH* accepted by ACM MMSys'24.

We are currently preparing the code to be released aligning with the camera-ready submission.

---

## Goal

+ Measure the performance of state-of-the-art dash.js low latency live streaming ABR algorithms under Starlink network

+ Utilize Starlink satellite handover feature at `12-27-42-57` second every minute to improve live streaming performance

## Measurement

### Real network

+ Starlink client, streaming from GCP us-west

+ TELUS/UVic client, streaming from GCP us-west

### Emulation

+ Dynamically add artificial delay and packet loss on Nginx Docker container to simulate the satellite handovers

## Scenario

Target latency: 

+ 1s, 2s, 3s, 4s, 5s, 6s

ABR algorithms

+ CMAB (The proposed algorithm using contextual multi-armed bandit)

+ Dynamic (dash.js Default)

+ L2A

+ LoL+

+ Constant bitrate (No ABR)

## TODO

- [ ] Record dash.js events when a video segment download started and how long does that last

- [ ] Multipath TAP/TUN. Not strictly multipath QUIC, multipath packet scheduling?

## Misc

### DASH Video Source

+ https://dash.akamaized.net/WAVE/vectors/switching_sets/12.5_25_50/ss1/2023-04-28/stream.mpd from https://cta-wave.github.io/Test-Content/. 

+ https://us-west.gcp.clarkzjw.ca/livesim2/vectors/switching_sets/12.5_25_50/ss1/2023-04-28/stream.mpd

+ https://nginx/livesim2/vectors/switching_sets/12.5_25_50/ss1/2023-04-28/stream.mpd

+ https://cmafref.akamaized.net/cmaf/live-ull/2006350/akambr/out.mpd

### UDP Buffer Sizes

https://github.com/quic-go/quic-go/wiki/UDP-Buffer-Sizes

```bash
sudo sysctl -w net.core.rmem_max=2500000
sudo sysctl -w net.core.wmem_max=2500000
```



### CMAF

ffmpeg streaming, from https://moctodemo.akamaized.net/tools/ffbuilder/, https://github.com/peterchave/ffbuilder

testclip.mp4: https://moctodemo.akamaized.net/content/testclip.mp4

https://github.com/peterchave/install-ll-encoder/blob/master/script.sh

https://docs.unified-streaming.com/documentation/package/index.html

```bash
#!/bin/bash

#Generated by command builder r0.3h

timestamp="$(date +%s)"

ffmpeg \
\
-re -fflags +genpts -stream_loop -1 -i testclip.mp4 \
\
-flags +global_header -r 30000/1001 \
\
-filter_complex "scale=1920x1080" \
\
-pix_fmt yuv420p \
-c:v libx264 \
\
-b:v:0 14828.408K -maxrate:v:0 14828.408K -bufsize:v:0 14828.408K/2 \
\
-g:v 30 -keyint_min:v 30 -sc_threshold:v 0 \
\
-color_primaries bt709 -color_trc bt709 -colorspace bt709 \
\
-c:a aac -ar 48000 -b:a 96k \
\
-map 0:v:0 \
-map 0:a:0 \
\
-preset veryfast \
-tune zerolatency \
\
-f mpegts 'udp://127.0.0.1:2222?pkt_size=1316'
```

```bash
ffplay udp://127.0.0.1:2222?pkt_size=1316
```

### Bento4, GPAC

```bash
mp4dash --profiles live --use-segment-list result.cmfv
mp4dash --profiles live --use-segment-timeline result.cmfv

MP4Box -dash 2000 -frag 500 -profile live -out out -segment-timeline -url-template output.mp4
```

### LL-DASH

+ https://github.com/gpac/gpac/wiki/LL-DASH

### Fast Switch

+ Disable Fast Switch according to MMSys 2023 BBC R&D paper?


## Install Terraform

https://developer.hashicorp.com/terraform/install


## Install gcloud CLI

https://cloud.google.com/sdk/docs/install

then run `gcloud init`

## Terraform Provision VM

edit `terraform.tfvars`

then `terraform init`, 

`gcloud auth application-default login`

`terraform plan` and `terraform apply`

SSH login to the new VM, wait until `/var/log/cloud-init-output.log` is finished.
```
[...]

Cloud-init v. 23.1.2-0ubuntu0~23.04.1 finished at Fri, 08 Dec 2023 23:20:04 +0000. Datasource DataSourceGCELocal.  Up 1117.00 seconds
```

apply File Watch Limit adjustment

```bash
echo fs.inotify.max_user_watches= 131070 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p
```

For real world experiments, deploy live video streaming server on the cloud VM by

```bash
docker compose -f docker-compose-ingest.yaml up -d
```

after that, the MPD file can be retrieved at

`https://<cloud-vm-ip>/livesim2/vectors/switching_sets/12.5_25_50/ss1/2023-04-28/stream.mpd`

you might want to use the broswer to visit the URL once to acknowledge the insecure HTTPS warning.

update `experiment.json` with this new MPD_URL

and test it can be played back at dash.js sample player

https://reference.dashif.org/dash.js/latest/samples/low-latency/testplayer/testplayer.html
